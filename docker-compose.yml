services:
  asterisk:
    image: andrius/asterisk:18-current
    container_name: bombardilo-asterisk
    ports:
      - "5060:5060/udp"  # SIP
      - "5060:5060/tcp"  # SIP TCP
      - "8088:8088/tcp"  # ARI HTTP
      - "10000-10050:10000-10050/udp"  # RTP range
    volumes:
      - ./asterisk:/etc/asterisk
    environment:
      - ASTERISK_UID=1000
      - ASTERISK_GID=1000
    networks:
      - bombardilo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "asterisk", "-rx", "core show version"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # Remove command override - let the image use its default entrypoint
    # The andrius/asterisk image handles startup automatically

  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: bombardilo-orchestrator
    environment:
      - ARI_URL=http://asterisk:8088
      - ARI_USER=voicebot
      - ARI_PASS=voicebot_pass
      - ARI_APP=voicebot
      - MEDIA_HOST=media-service
      - MEDIA_IP=172.18.0.2
      - MEDIA_PORT_BASE=40000
      - MEDIA_API_PORT=5000
      - MEDIA_API_URL=http://media-service:5000
      - MEDIA_MODE=echo
      - AUDIO_FORMAT=ulaw
      - LOG_LEVEL=debug
    depends_on:
      asterisk:
        condition: service_healthy
      media-service:
        condition: service_started
    networks:
      - bombardilo-network
    restart: unless-stopped

  media-service:
    build:
      context: ./media-service
      dockerfile: Dockerfile
    container_name: bombardilo-media-service
    ports:
      - "40000-40050:40000-40050/udp"  # RTP ports for media sessions
      - "5000:5000/tcp"  # HTTP API
    environment:
      - MEDIA_HOST=0.0.0.0
      - MEDIA_PORT_BASE=40000
      - MEDIA_API_PORT=5000
      - MEDIA_MODE=echo
      - ASR_PROVIDER=mock
      - LLM_PROVIDER=mock
      - TTS_PROVIDER=mock
      - SYSTEM_PROMPT=You are a helpful assistant.
    networks:
      - bombardilo-network
    restart: unless-stopped

networks:
  bombardilo-network:
    driver: bridge
